<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Transaction History ‚Äî Money Tracker</title>
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, sans-serif;
            max-width: 1100px;
            margin: 40px auto;
            background: #f0f2f5;
            color: #333;
            padding: 0 20px 40px;
        }

        .card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }

        select,
        input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            box-sizing: border-box;
        }

        label {
            font-size: 11px;
            color: #888;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            display: block;
            margin-bottom: 4px;
        }

        .btn {
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }

        .btn-green {
            background: #2ecc71;
        }

        .btn-blue {
            background: #3498db;
        }

        .btn-red {
            background: #e74c3c;
        }

        .btn-outline {
            background: white;
            color: #555;
            border: 1px solid #ddd;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 14px;
            padding: 2px 4px;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
        }

        /* Summary cards */
        .summary {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .summary .card {
            text-align: center;
            padding: 16px;
        }

        .summary-label {
            font-size: 11px;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .summary-value {
            font-size: 22px;
            font-weight: bold;
        }

        /* Filters */
        .filters {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr 1fr auto;
            gap: 12px;
            align-items: end;
        }

        .filters select,
        .filters input {
            width: 100%;
            margin: 0;
        }

        /* Table */
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead tr {
            background: #f8f9fa;
            text-align: left;
        }

        th {
            padding: 14px 16px;
            color: #888;
            font-weight: 600;
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        td {
            padding: 12px 16px;
        }

        tbody tr {
            border-top: 1px solid #f0f0f0;
        }

        tbody tr:nth-child(even) {
            background: #fafbfc;
        }

        tbody tr:hover {
            background: #f0f4ff;
        }

        .badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .badge-income {
            background: #eafaf1;
            color: #27ae60;
        }

        .badge-expense {
            background: #fdecea;
            color: #c0392b;
        }

        .badge-transfer {
            background: #eee8f5;
            color: #8e44ad;
        }

        .amount-transfer {
            color: #8e44ad;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .amount-income {
            color: #27ae60;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .amount-expense {
            color: #c0392b;
            font-weight: bold;
            font-variant-numeric: tabular-nums;
        }

        .pagination {
            padding: 16px;
            border-top: 1px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .pagination-info {
            font-size: 13px;
            color: #888;
        }

        /* Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            border-radius: 16px;
            padding: 28px;
            width: 440px;
            max-width: 90vw;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
        }

        .modal h3 {
            margin: 0 0 16px;
            color: #2c3e50;
        }

        .modal select,
        .modal input {
            width: 100%;
            margin: 8px 0;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }

        .modal-buttons .btn,
        .modal-buttons .btn-outline {
            flex: 1;
            text-align: center;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>

<body>

    <!-- Header -->
    <div class="header">
        <a href="/" class="btn-outline">‚Üê Back</a>
        <h2 style="margin: 0; color: #2c3e50;">üìã Transaction History</h2>
    </div>

    <!-- Summary -->
    <div class="summary">
        <div class="card">
            <div class="summary-label">Income</div>
            <div id="total-income" class="summary-value" style="color: #2ecc71;">0.00</div>
        </div>
        <div class="card">
            <div class="summary-label">Expenses</div>
            <div id="total-expense" class="summary-value" style="color: #e74c3c;">0.00</div>
        </div>
        <div class="card">
            <div class="summary-label">Balance</div>
            <div id="total-net" class="summary-value" style="color: #2c3e50;">0.00</div>
        </div>
    </div>

    <!-- Filters -->
    <div class="card" style="margin-bottom: 20px;">
        <div class="filters" style="grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));">
            <div>
                <label>Account</label>
                <select id="filter_account" onchange="loadTransactions()">
                    <option value="">All Accounts</option>
                </select>
            </div>
            <div>
                <label>Category</label>
                <select id="filter_category" onchange="onFilterCategoryChange(); loadTransactions();">
                    <option value="">All Categories</option>
                </select>
            </div>
            <div id="filter-sub-block" style="display:none;">
                <label>Subcategory</label>
                <select id="filter_subcategory" onchange="loadTransactions()">
                    <option value="">All</option>
                </select>
            </div>
            <div>
                <label>From</label>
                <input type="date" id="filter_from" onchange="loadTransactions()">
            </div>
            <div>
                <label>To</label>
                <input type="date" id="filter_to" onchange="loadTransactions()">
            </div>
        </div>
    </div>

    <!-- Table -->
    <div class="card" style="padding: 0; overflow: hidden;">
        <table>
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Description</th>
                    <th>Category</th>
                    <th>Account</th>
                    <th style="text-align: right;">Amount</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody id="transactions-body">
                <tr>
                    <td colspan="6" class="empty-state">Loading...</td>
                </tr>
            </tbody>
        </table>
        <div class="pagination">
            <span id="pagination-info" class="pagination-info"></span>
            <div>
                <button class="btn-outline" id="btn-prev" onclick="prevPage()" style="display:none;">‚Üê Prev</button>
                <button class="btn-outline" id="btn-next" onclick="nextPage()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Edit Transaction Modal -->
    <div id="edit-txn-modal" class="modal-overlay" onclick="closeModal(event)">
        <div class="modal" onclick="event.stopPropagation()">
            <h3>‚úèÔ∏è Edit Transaction</h3>
            <input type="hidden" id="edit_txn_id">
            <label>Amount</label>
            <input type="number" id="edit_txn_amount" step="0.01">
            <label>Description</label>
            <input type="text" id="edit_txn_desc">
            <label>Date</label>
            <input type="datetime-local" id="edit_txn_date">
            <label>Account</label>
            <select id="edit_txn_account"></select>
            <label>Category</label>
            <select id="edit_txn_category" onchange="onEditCategoryChange()"></select>
            <div id="edit-sub-block" style="display:none;">
                <label>Subcategory</label>
                <select id="edit_txn_subcategory"></select>
            </div>
            <div class="modal-buttons">
                <button class="btn btn-green" onclick="saveTransaction()">üíæ Save</button>
                <button class="btn btn-red" onclick="deleteTransaction()">üóëÔ∏è Delete</button>
                <button class="btn-outline"
                    onclick="document.getElementById('edit-txn-modal').classList.remove('active')">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = "/api";
        const PAGE_SIZE = 20;
        let currentOffset = 0;
        let allAccounts = [];
        let allCategories = [];
        let currentTransactions = [];

        // --- INIT ---
        async function init() {
            const [accRes, catRes] = await Promise.all([
                fetch(`${API_URL}/accounts/`),
                fetch(`${API_URL}/categories/`)
            ]);
            allAccounts = await accRes.json();
            allCategories = await catRes.json();

            populateFilterDropdowns();
            setDefaultDateRange();
            loadTransactions();
        }

        function populateFilterDropdowns() {
            // Account filter
            const accSelect = document.getElementById('filter_account');
            accSelect.innerHTML = '<option value="">All Accounts</option>' +
                allAccounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            // Category filter ‚Äî root categories only
            const parents = allCategories.filter(c => !c.parent_id);
            document.getElementById('filter_category').innerHTML =
                '<option value="">All Categories</option>' +
                parents.map(p => `<option value="${p.id}">${p.name} (${p.type === 'income' ? '‚Üë' : '‚Üì'})</option>`).join('');

            // Modal dropdowns
            document.getElementById('edit_txn_account').innerHTML =
                allAccounts.map(a => `<option value="${a.id}">${a.name}</option>`).join('');

            document.getElementById('edit_txn_category').innerHTML =
                parents.map(p => `<option value="${p.id}">${p.name} (${p.type === 'income' ? '‚Üë' : '‚Üì'})</option>`).join('');
        }

        function onFilterCategoryChange() {
            const parentId = document.getElementById('filter_category').value;
            const subBlock = document.getElementById('filter-sub-block');
            const subSelect = document.getElementById('filter_subcategory');

            if (!parentId) {
                subBlock.style.display = 'none';
                subSelect.innerHTML = '<option value="">All</option>';
                return;
            }

            const children = allCategories.filter(c => c.parent_id === parseInt(parentId));
            if (children.length > 0) {
                subBlock.style.display = 'block';
                subSelect.innerHTML = '<option value="">All Subcategories</option>' +
                    children.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } else {
                subBlock.style.display = 'none';
                subSelect.innerHTML = '<option value="">All</option>';
            }
        }

        function onEditCategoryChange() {
            const parentId = parseInt(document.getElementById('edit_txn_category').value);
            const children = allCategories.filter(c => c.parent_id === parentId);
            const subBlock = document.getElementById('edit-sub-block');
            const subSelect = document.getElementById('edit_txn_subcategory');

            if (children.length > 0) {
                subBlock.style.display = 'block';
                subSelect.innerHTML =
                    `<option value="${parentId}">‚Äî No Subcategory ‚Äî</option>` +
                    children.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            } else {
                subBlock.style.display = 'none';
                subSelect.innerHTML = '';
            }
        }

        function setDefaultDateRange() {
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            document.getElementById('filter_from').value = firstDay.toISOString().slice(0, 10);
            document.getElementById('filter_to').value = now.toISOString().slice(0, 10);
        }

        // --- LOAD TRANSACTIONS ---
        async function loadTransactions() {
            const params = new URLSearchParams();
            const accId = document.getElementById('filter_account').value;
            const catId = document.getElementById('filter_category').value;
            const dateFrom = document.getElementById('filter_from').value;
            const dateTo = document.getElementById('filter_to').value;

            const subCatId = document.getElementById('filter_subcategory').value;
            if (accId) params.set('account_id', accId);
            if (subCatId) params.set('category_id', subCatId);
            else if (catId) params.set('category_id', catId);
            if (dateFrom) params.set('date_from', `${dateFrom}T00:00:00`);
            if (dateTo) params.set('date_to', `${dateTo}T23:59:59`);
            params.set('limit', PAGE_SIZE);
            params.set('offset', currentOffset);

            try {
                const res = await fetch(`${API_URL}/transactions/?${params.toString()}`);
                currentTransactions = await res.json();
                renderTransactions(currentTransactions);
                updateSummary(currentTransactions);
                updatePagination(currentTransactions.length);
            } catch (e) {
                console.error("Error loading transactions:", e);
            }
        }

        function renderTransactions(transactions) {
            const tbody = document.getElementById('transactions-body');
            if (transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="empty-state">No transactions for the selected period</td></tr>';
                return;
            }

            tbody.innerHTML = transactions.map(t => {
                const isIncome = t.category_type === 'income';
                const isTransfer = t.category_type === 'transfer';
                const date = new Date(t.created_at);
                const dateStr = date.toLocaleDateString('en-US', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const timeStr = date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                let badgeClass, badgeIcon, amountClass, amountPrefix;
                if (isTransfer) {
                    badgeClass = 'badge-transfer';
                    badgeIcon = '‚áÑ';
                    amountClass = 'amount-transfer';
                    amountPrefix = '';
                } else if (isIncome) {
                    badgeClass = 'badge-income';
                    badgeIcon = '‚Üë';
                    amountClass = 'amount-income';
                    amountPrefix = '+';
                } else {
                    badgeClass = 'badge-expense';
                    badgeIcon = '‚Üì';
                    amountClass = 'amount-expense';
                    amountPrefix = '-';
                }

                return `
                <tr>
                    <td style="color: #666; white-space: nowrap; font-size: 13px;">
                        ${dateStr}<br><span style="font-size: 11px; color: #aaa;">${timeStr}</span>
                    </td>
                    <td style="font-weight: 500;">${t.description || '‚Äî'}</td>
                    <td>
                        <span class="badge ${badgeClass}">
                            ${badgeIcon} ${t.category_name}
                        </span>
                    </td>
                    <td style="color: #666;">${t.account_name}</td>
                    <td style="text-align: right;" class="${amountClass}">
                        ${amountPrefix}${t.amount.toFixed(2)}
                    </td>
                    <td>
                        <button class="btn-icon" onclick="openEditModal(${t.id})" title="${isTransfer ? 'Delete transfer' : 'Edit'}">${isTransfer ? 'üóëÔ∏è' : '‚úèÔ∏è'}</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function updateSummary(transactions) {
            let income = 0, expense = 0;
            transactions.forEach(t => {
                if (t.category_type === 'income') income += t.amount;
                else if (t.category_type === 'expense') expense += t.amount;
                // transfers are not counted in income/expenses
            });
            document.getElementById('total-income').textContent = `+${income.toFixed(2)}`;
            document.getElementById('total-expense').textContent = `-${expense.toFixed(2)}`;
            const net = income - expense;
            const netEl = document.getElementById('total-net');
            netEl.textContent = `${net >= 0 ? '+' : ''}${net.toFixed(2)}`;
            netEl.style.color = net >= 0 ? '#2ecc71' : '#e74c3c';
        }

        function updatePagination(count) {
            document.getElementById('pagination-info').textContent =
                `Showing ${currentOffset + 1}‚Äì${currentOffset + count} transactions`;
            document.getElementById('btn-prev').style.display = currentOffset > 0 ? 'inline-block' : 'none';
            document.getElementById('btn-next').style.display = count >= PAGE_SIZE ? 'inline-block' : 'none';
        }

        function nextPage() {
            currentOffset += PAGE_SIZE;
            loadTransactions();
        }

        function prevPage() {
            currentOffset = Math.max(0, currentOffset - PAGE_SIZE);
            loadTransactions();
        }

        function getEditSelectedCategoryId() {
            const subSelect = document.getElementById('edit_txn_subcategory');
            if (document.getElementById('edit-sub-block').style.display !== 'none' && subSelect.value) {
                return parseInt(subSelect.value);
            }
            return parseInt(document.getElementById('edit_txn_category').value);
        }

        function resetFilters() {
            document.getElementById('filter_account').value = '';
            document.getElementById('filter_category').value = '';
            document.getElementById('filter-sub-block').style.display = 'none';
            document.getElementById('filter_subcategory').innerHTML = '<option value="">All</option>';
            setDefaultDateRange();
            currentOffset = 0;
            loadTransactions();
        }

        // --- EDIT/DELETE TRANSACTION ---
        function openEditModal(id) {
            const txn = currentTransactions.find(t => t.id === id);
            if (!txn) return;

            // Transfers ‚Äî delete only
            if (txn.is_transfer) {
                if (confirm(`Delete transfer ${txn.amount.toFixed(2)} (${txn.description})? Balances will be adjusted.`)) {
                    deleteTransactionById(txn.id);
                }
                return;
            }

            document.getElementById('edit_txn_id').value = txn.id;
            document.getElementById('edit_txn_amount').value = txn.amount;
            document.getElementById('edit_txn_desc').value = txn.description || '';
            document.getElementById('edit_txn_account').value = txn.account_id;

            // Category: determine parent and sub
            const cat = allCategories.find(c => c.id === txn.category_id);
            if (cat && cat.parent_id) {
                document.getElementById('edit_txn_category').value = cat.parent_id;
                onEditCategoryChange();
                document.getElementById('edit_txn_subcategory').value = cat.id;
            } else {
                document.getElementById('edit_txn_category').value = txn.category_id;
                onEditCategoryChange();
            }

            // Date
            const d = new Date(txn.created_at);
            d.setMinutes(d.getMinutes() - d.getTimezoneOffset());
            document.getElementById('edit_txn_date').value = d.toISOString().slice(0, 16);

            document.getElementById('edit-txn-modal').classList.add('active');
        }

        function closeModal(e) {
            if (e.target === e.currentTarget) {
                e.target.classList.remove('active');
            }
        }

        async function saveTransaction() {
            const id = document.getElementById('edit_txn_id').value;
            const data = {
                amount: parseFloat(document.getElementById('edit_txn_amount').value),
                description: document.getElementById('edit_txn_desc').value,
                account_id: parseInt(document.getElementById('edit_txn_account').value),
                category_id: getEditSelectedCategoryId(),
                created_at: new Date(document.getElementById('edit_txn_date').value).toISOString(),
            };

            const res = await fetch(`${API_URL}/transactions/${id}`, {
                method: 'PUT', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if (res.ok) {
                document.getElementById('edit-txn-modal').classList.remove('active');
                loadTransactions();
            } else {
                const err = await res.json();
                alert(err.detail || "Save error");
            }
        }

        async function deleteTransactionById(id) {
            const res = await fetch(`${API_URL}/transactions/${id}`, { method: 'DELETE' });
            if (res.ok) {
                loadTransactions();
            } else {
                const err = await res.json();
                alert(err.detail || "Delete error");
            }
        }

        async function deleteTransaction() {
            if (!confirm("Delete this transaction? Account balance will be adjusted.")) return;

            const id = document.getElementById('edit_txn_id').value;
            document.getElementById('edit-txn-modal').classList.remove('active');
            await deleteTransactionById(id);
        }

        // --- START ---
        init();
    </script>
</body>

</html>