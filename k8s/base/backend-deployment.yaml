apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
spec:
  replicas: 1
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1        # Spin up new pod BEFORE removing old one
      maxUnavailable: 0  # Zero downtime — always full capacity during rollout
  selector:
    matchLabels:
      app: backend
  template:
    metadata:
      labels:
        app: backend
    spec:
      # -----------------------------------------------------------------------
      # Pod-level security: ensure no container can escalate to root
      # -----------------------------------------------------------------------
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      initContainers:
        - name: wait-for-postgres
          image: busybox:1.37
          command:
            - sh
            - -c
            - |
              echo "Waiting for PostgreSQL..."
              until nc -z postgres-service 5432; do
                echo "PostgreSQL not ready, retrying in 2s..."
                sleep 2
              done
              echo "PostgreSQL is ready!"
          # -----------------------------------------------------------------
          # initContainer also hardened — attackers can exploit init phase too
          # -----------------------------------------------------------------
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          resources:
            requests:
              cpu: 10m
              memory: 16Mi
            limits:
              cpu: 50m
              memory: 32Mi
      containers:
        - name: backend
          image: BACKEND_IMAGE
          ports:
            - containerPort: 8000
          env:
            - name: POSTGRES_USER
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_USER
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_PASSWORD
            - name: POSTGRES_DB
              valueFrom:
                secretKeyRef:
                  name: postgres-credentials
                  key: POSTGRES_DB
            - name: IP_INT
              value: postgres-service
            - name: PORT
              value: "5432"
            - name: REDIS_HOST
              value: redis-service
            - name: REDIS_PORT
              value: "6379"
            # -- Performance tuning --
            - name: WEB_CONCURRENCY
              value: "2"
            - name: RATE_LIMIT_MAX
              value: "200"
          resources:
            requests:
              cpu: 100m
              memory: 128Mi
            limits:
              cpu: 1000m
              memory: 512Mi
          # -----------------------------------------------------------------
          # Container-level security (Pod Security Standards: restricted)
          # -----------------------------------------------------------------
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop: ["ALL"]
          # -----------------------------------------------------------------
          # tmpfs for /tmp — Python needs writable temp dir for __pycache__,
          # .pyc files, etc. readOnlyRootFilesystem blocks writes to /,
          # so we mount an emptyDir (RAM-backed) at /tmp.
          # -----------------------------------------------------------------
          volumeMounts:
            - name: tmp
              mountPath: /tmp
          livenessProbe:
            httpGet:
              path: /health
              port: 8000
            initialDelaySeconds: 15
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 5
          readinessProbe:
            httpGet:
              path: /ready
              port: 8000
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 5
            failureThreshold: 3
      volumes:
        - name: tmp
          emptyDir:
            medium: Memory
            sizeLimit: 64Mi
