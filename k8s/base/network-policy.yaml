# =============================================================================
# Phase 4: Zero-Trust Network Policies (7 granular policies)
# =============================================================================
# INTERVIEW NOTE (Fintech/Security):
#   PCI DSS requires microsegmentation — if an attacker compromises one pod,
#   they should NOT be able to reach other services. Default-deny + explicit
#   allow is the gold standard. This is "zero-trust networking" in K8s.
# =============================================================================

# --- Policy 1: Default Deny All Ingress & Egress ---
# Foundation of zero-trust: block everything, then whitelist explicitly.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-all
spec:
  podSelector: {}
  policyTypes:
    - Ingress
    - Egress

---
# --- Policy 2: Frontend — accept traffic from ingress-nginx only ---
# Users hit NGINX Ingress → frontend. No other pod should reach frontend.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-ingress
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx

---
# --- Policy 3: Frontend — egress to DNS only ---
# Frontend (nginx) serves static files, doesn't need to talk to backend/DB.
# DNS is needed for K8s internal resolution.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-egress-dns
spec:
  podSelector:
    matchLabels:
      app: frontend
  policyTypes:
    - Egress
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# --- Policy 4: Backend — accept traffic from ingress-nginx only ---
# API requests come through ingress. No pod-to-pod calls to backend.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-ingress
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Ingress
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx

---
# --- Policy 5: Backend — egress to postgres, redis, and DNS only ---
# Backend needs: postgres:5432, redis:6379, DNS.
# It cannot reach the internet, other namespaces, or any other pod.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-egress
spec:
  podSelector:
    matchLabels:
      app: backend
  policyTypes:
    - Egress
  egress:
    # PostgreSQL
    - to:
        - podSelector:
            matchLabels:
              app: postgres
      ports:
        - protocol: TCP
          port: 5432
    # Redis
    - to:
        - podSelector:
            matchLabels:
              app: redis
      ports:
        - protocol: TCP
          port: 6379
    # DNS (kube-system)
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - protocol: UDP
          port: 53
        - protocol: TCP
          port: 53

---
# --- Policy 6: PostgreSQL — accept connections from backend only ---
# DB should NEVER be reachable from frontend or any other pod.
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-postgres-ingress
spec:
  podSelector:
    matchLabels:
      app: postgres
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: backend
      ports:
        - protocol: TCP
          port: 5432

---
# --- Policy 7: Redis — accept connections from backend only ---
# Same as postgres — cache is sensitive (rate limit state, session data).
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-redis-ingress
spec:
  podSelector:
    matchLabels:
      app: redis
  policyTypes:
    - Ingress
  ingress:
    - from:
        - podSelector:
            matchLabels:
              app: backend
      ports:
        - protocol: TCP
          port: 6379
